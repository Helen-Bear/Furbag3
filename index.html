<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Furbag Montefiore</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Segoe UI',sans-serif;touch-action:manipulation}

/* Sky backgrounds */
body{transition:background 4s}
body.night{background:linear-gradient(180deg,#0a0e27 0%,#1a1a3e 40%,#2d1b4e 100%)}
body.dawn{background:linear-gradient(180deg,#2d1b4e 0%,#e87461 30%,#f4a261 60%,#ffd4a2 100%)}
body.day{background:linear-gradient(180deg,#4a90d9 0%,#87ceeb 40%,#b8e4f0 100%)}
body.dusk{background:linear-gradient(180deg,#1a1a3e 0%,#c44536 30%,#e87461 60%,#f4a261 100%)}

#game{position:relative;width:100%;max-width:420px;height:100vh;margin:0 auto;overflow:hidden}

/* Stars */
#starsC{position:absolute;top:0;left:0;width:100%;height:60%;pointer-events:none;opacity:0;transition:opacity 3s}
.night #starsC{opacity:1}.dawn #starsC{opacity:.3}.dusk #starsC{opacity:.4}
.star{position:absolute;background:#fff;border-radius:50%;animation:twinkle 2s infinite alternate}
@keyframes twinkle{0%{opacity:.2}100%{opacity:1}}

/* Clouds */
#cloudsC{position:absolute;top:0;left:0;width:100%;height:50%;pointer-events:none;opacity:0;transition:opacity 3s}
.day #cloudsC{opacity:.8}.dawn #cloudsC{opacity:.5}.dusk #cloudsC{opacity:.4}
.cloud{position:absolute;background:rgba(255,255,255,.7);border-radius:50%;animation:drift linear infinite}
@keyframes drift{0%{transform:translateX(-100px)}100%{transform:translateX(calc(100vw + 100px))}}

/* Sun & Moon */
#sun,#moon{position:absolute;border-radius:50%;transition:opacity 3s;pointer-events:none}
#sun{width:50px;height:50px;background:radial-gradient(#fff700,#ffa500);top:12%;left:70%;box-shadow:0 0 40px #ffa50088;opacity:0}
#moon{width:36px;height:36px;background:radial-gradient(#e8e8ff,#c8c8e0);top:10%;left:25%;box-shadow:0 0 20px #aaaaff44;opacity:0}
.day #sun{opacity:1}.dawn #sun{opacity:.6}.night #moon{opacity:1}.dusk #moon{opacity:.3}

/* Top bar */
#topBar{position:absolute;top:8px;left:8px;right:8px;display:flex;justify-content:space-between;align-items:center;z-index:20}
#nameTag{font-size:11px;color:rgba(255,255,255,.85);font-style:italic;text-shadow:0 1px 4px rgba(0,0,0,.5)}
#clock{font-size:11px;color:rgba(255,255,255,.7);font-variant-numeric:tabular-nums}
.top-btn{background:rgba(0,0,0,.3);color:#fff;border:none;border-radius:12px;padding:4px 10px;font-size:11px;cursor:pointer;backdrop-filter:blur(4px)}
.top-btn:hover{background:rgba(0,0,0,.5)}

/* Room */
#room{position:absolute;bottom:0;left:0;right:0;height:62%;transition:background 3s}
.night #room{background:linear-gradient(180deg,#1a1520 0%,#231c2e 100%)}
.dawn #room{background:linear-gradient(180deg,#3d2b3a 0%,#4a3545 100%)}
.day #room{background:linear-gradient(180deg,#d4b896 0%,#c4a882 100%)}
.dusk #room{background:linear-gradient(180deg,#3a2a35 0%,#4a3545 100%)}

/* Floor */
#floor{position:absolute;bottom:0;left:0;right:0;height:35%;transition:background 3s}
.night #floor{background:linear-gradient(180deg,#1e1828 0%,#16111f 100%)}
.dawn #floor{background:linear-gradient(180deg,#3a2a25 0%,#2e2220 100%)}
.day #floor{background:linear-gradient(180deg,#8b7355 0%,#7a6548 100%)}
.dusk #floor{background:linear-gradient(180deg,#352828 0%,#2a2020 100%)}

/* Rug */
#rug{position:absolute;bottom:8%;left:20%;width:60%;height:18%;background:radial-gradient(ellipse,#8b4066,#6b2d4f);border-radius:50%;opacity:.5}

/* Window */
#window{position:absolute;top:8%;left:15%;width:28%;height:35%;border:4px solid #5a4a3a;border-radius:6px;overflow:hidden;background:rgba(135,206,235,.15)}
.night #window{background:rgba(10,14,39,.3);border-color:#3a3050}
#windowGlow{position:absolute;inset:0;opacity:0;transition:opacity 3s;background:rgba(255,200,100,.08)}
.day #windowGlow{opacity:1}.dawn #windowGlow{opacity:.5}

/* Shelf */
#shelf{position:absolute;top:12%;right:10%;width:30%;height:6px;background:#5a4a3a;border-radius:2px}
.night #shelf{background:#3a3050}
#shelfItems{position:absolute;top:10%;right:10%;display:flex;gap:4px}
.book{width:8px;border-radius:1px}
#plant{font-size:16px;position:relative;top:-2px}

/* Furniture items */
#bowl{position:absolute;bottom:12%;left:8%;font-size:22px;cursor:pointer;filter:drop-shadow(0 2px 3px rgba(0,0,0,.3))}
#bed{position:absolute;bottom:10%;left:55%;width:60px;height:28px;background:radial-gradient(#7b4fa2,#5a3578);border-radius:50% 50% 45% 45%;cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,.3)}
#yarn{position:absolute;bottom:13%;left:35%;font-size:18px;cursor:pointer}
#mouse{position:absolute;bottom:12%;right:12%;font-size:16px;cursor:pointer}

/* Windowsill - cat can sit here */
#windowsill{position:absolute;top:43%;left:13%;width:32%;height:8px;background:#5a4a3a;border-radius:2px}
.night #windowsill{background:#3a3050}

/* Cat */
#cw{position:absolute;bottom:14%;left:50%;transform:translateX(-50%);transition:none;z-index:10;cursor:pointer}
#cat{position:relative;width:40px;height:40px}

/* Cat body parts */
.cat-body{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:28px;height:22px;background:#1a1a1a;border-radius:50% 50% 45% 45%}
.cat-head{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);width:22px;height:18px;background:#1a1a1a;border-radius:50% 50% 40% 40%}
.ear-l,.ear-r{position:absolute;top:-5px;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:8px solid #1a1a1a}
.ear-l{left:1px}.ear-r{right:1px}
.ear-inner-l,.ear-inner-r{position:absolute;top:-3px;width:0;height:0;border-left:3px solid transparent;border-right:3px solid transparent;border-bottom:5px solid #2a1a2a}
.ear-inner-l{left:3px}.ear-inner-r{right:3px}
.eye-l,.eye-r{position:absolute;top:5px;width:5px;height:5px;background:#2ecc40;border-radius:50%;box-shadow:0 0 4px #2ecc4088}
.eye-l{left:3px}.eye-r{right:3px}
.pupil{position:absolute;top:50%;left:50%;width:2px;height:4px;background:#111;border-radius:50%;transform:translate(-50%,-50%)}
.nose{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:3px;height:2px;background:#ff9999;border-radius:50%}
.mouth-l,.mouth-r{position:absolute;bottom:2px;width:4px;height:3px;border-bottom:1px solid #ff999988;border-radius:0 0 50% 50%}
.mouth-l{left:6px}.mouth-r{right:6px}

/* Legs */
.leg{position:absolute;bottom:-6px;width:5px;height:8px;background:#1a1a1a;border-radius:0 0 3px 3px}
.leg-fl{left:4px}.leg-fr{right:4px}.leg-bl{left:8px}.leg-br{right:8px}

/* Tail */
.tail{position:absolute;bottom:4px;width:20px;height:4px;background:#1a1a1a;border-radius:4px;transform-origin:left center}
.facing-right .tail{left:-16px;transform:rotate(-15deg)}
.facing-left .tail{right:-16px;left:auto;transform-origin:right center;transform:rotate(15deg)}

/* Whiskers */
.whisker{position:absolute;height:1px;width:12px;background:rgba(200,200,200,.4)}
.wh-tl{top:8px;left:-8px;transform:rotate(-10deg)}
.wh-ml{top:10px;left:-9px;transform:rotate(0deg)}
.wh-bl{top:12px;left:-8px;transform:rotate(10deg)}
.wh-tr{top:8px;right:-8px;transform:rotate(10deg)}
.wh-mr{top:10px;right:-9px;transform:rotate(0deg)}
.wh-br{top:12px;right:-8px;transform:rotate(-10deg)}

/* Cat animations */
@keyframes walk{
  0%,100%{transform:rotate(0deg)}
  25%{transform:rotate(15deg)}
  75%{transform:rotate(-15deg)}
}
@keyframes tailWag{
  0%,100%{transform:rotate(-15deg)}
  50%{transform:rotate(-35deg)}
}
@keyframes tailWagLeft{
  0%,100%{transform:rotate(15deg)}
  50%{transform:rotate(35deg)}
}
@keyframes headBob{
  0%,100%{transform:translateX(-50%) translateY(0)}
  50%{transform:translateX(-50%) translateY(-2px)}
}
@keyframes eating{
  0%,100%{transform:translateX(-50%) translateY(0)}
  30%{transform:translateX(-50%) translateY(4px)}
  60%{transform:translateX(-50%) translateY(0)}
}
@keyframes purr{
  0%,100%{transform:translateX(-50%) scale(1)}
  50%{transform:translateX(-50%) scale(1.02)}
}
@keyframes kneading{
  0%,100%{height:8px}
  50%{height:5px}
}
@keyframes stretch{
  0%{width:28px;height:22px}
  30%{width:38px;height:16px}
  100%{width:28px;height:22px}
}
@keyframes roll{
  0%{transform:translateX(-50%) rotate(0deg)}
  25%{transform:translateX(-50%) rotate(90deg)}
  50%{transform:translateX(-50%) rotate(180deg)}
  75%{transform:translateX(-50%) rotate(270deg)}
  100%{transform:translateX(-50%) rotate(360deg)}
}
@keyframes pounce{
  0%{transform:translateX(-50%) translateY(0) scale(1)}
  30%{transform:translateX(-50%) translateY(-15px) scale(1.1)}
  60%{transform:translateX(-50%) translateY(2px) scale(.95)}
  100%{transform:translateX(-50%) translateY(0) scale(1)}
}
@keyframes archBack{
  0%,100%{border-radius:50% 50% 45% 45%;height:22px}
  50%{border-radius:50%;height:26px}
}
@keyframes sleepBreathe{
  0%,100%{transform:translateX(-50%) scale(1)}
  50%{transform:translateX(-50%) scale(1.04,1.06)}
}
@keyframes jump{
  0%{transform:translateY(0)}
  40%{transform:translateY(-60px)}
  70%{transform:translateY(-55px)}
  100%{transform:translateY(0)}
}
@keyframes blink{
  0%,45%,55%,100%{height:5px}
  48%,52%{height:1px}
}
@keyframes curiousTilt{
  0%,100%{transform:translateX(-50%) rotate(0deg)}
  50%{transform:translateX(-50%) rotate(12deg)}
}

/* Eyes glow at night */
.night .eye-l,.night .eye-r{box-shadow:0 0 8px #2ecc40cc}

/* Cat states */
.cat-walking .leg{animation:walk .3s infinite}
.cat-walking .tail{animation:tailWag .6s infinite}
.facing-left .cat-walking .tail{animation:tailWagLeft .6s infinite}
.cat-eating .cat-head{animation:eating .4s infinite}
.cat-sleeping .cat-body{animation:sleepBreathe 2s infinite ease-in-out}
.cat-sleeping .eye-l,.cat-sleeping .eye-r{height:1px !important;top:7px}
.cat-purring .cat-body{animation:purr .3s infinite}
.cat-grooming .cat-head{animation:headBob .5s infinite}
.cat-kneading .leg-fl,.cat-kneading .leg-fr{animation:kneading .4s infinite alternate}
.cat-stretching .cat-body{animation:stretch 1.5s ease-in-out}
.cat-rolling .cat-body{animation:roll 1s ease-in-out}
.cat-pouncing .cat-body{animation:pounce .6s ease-in-out}
.cat-arched .cat-body{animation:archBack .8s ease-in-out}
.cat-curious .cat-head{animation:curiousTilt 1s ease-in-out}
.cat-blinking .eye-l,.cat-blinking .eye-r{animation:blink 3s infinite}

/* ZZZ */
#zzz{position:absolute;top:-15px;left:50%;font-size:10px;color:rgba(255,255,255,.6);opacity:0;pointer-events:none}
.cat-sleeping #zzz{opacity:1;animation:floatZ 2s infinite}
@keyframes floatZ{0%{transform:translate(0,0);opacity:.6}100%{transform:translate(8px,-15px);opacity:0}}

/* Hearts */
#hearts{position:absolute;top:-20px;left:50%;pointer-events:none}
.heart{position:absolute;font-size:12px;animation:floatHeart 1s ease-out forwards;opacity:0}
@keyframes floatHeart{0%{opacity:1;transform:translate(0,0) scale(.5)}50%{opacity:.8;transform:translate(var(--hx),-20px) scale(1)}100%{opacity:0;transform:translate(var(--hx),-35px) scale(.6)}}

/* Music notes */
.music-note{position:absolute;font-size:10px;animation:floatNote 1.5s ease-out forwards;opacity:0;pointer-events:none}
@keyframes floatNote{0%{opacity:.8;transform:translateY(0) rotate(0deg)}100%{opacity:0;transform:translateY(-30px) rotate(20deg)}}

/* Activity label */
#al{position:absolute;top:35%;left:50%;transform:translateX(-50%);font-size:10px;color:rgba(255,255,255,.7);text-align:center;pointer-events:none;opacity:0;transition:opacity .5s}

/* Stats panel */
#stats{position:absolute;bottom:80px;left:8px;right:8px;display:flex;flex-direction:column;gap:3px;z-index:15}
.st{display:flex;align-items:center;gap:4px}
.st-i{font-size:11px;width:18px;text-align:center}
.st-b{flex:1;height:8px;background:rgba(0,0,0,.25);border-radius:4px;overflow:hidden}
.st-f{height:100%;border-radius:4px;transition:width .5s}
.st-l{font-size:9px;color:rgba(255,255,255,.6);width:36px}
.fd{background:linear-gradient(90deg,#e67e22,#f1c40f)}
.en{background:linear-gradient(90deg,#2980b9,#3498db)}
.ha{background:linear-gradient(90deg,#e74c3c,#e91e63)}
.lo{background:linear-gradient(90deg,#e91e63,#ff69b4)}
.cl{background:linear-gradient(90deg,#1abc9c,#2ecc71)}

/* Mood text */
#mood{position:absolute;bottom:62px;left:8px;right:8px;text-align:center;font-size:11px;color:rgba(255,255,255,.7);font-style:italic;z-index:15}

/* Buttons */
.btns{position:absolute;bottom:10px;left:8px;right:8px;display:flex;justify-content:space-around;z-index:15}
.bg{text-align:center}
.btn{width:44px;height:44px;border-radius:50%;border:none;font-size:20px;cursor:pointer;background:rgba(255,255,255,.12);backdrop-filter:blur(4px);transition:all .2s}
.btn:active{transform:scale(.9);background:rgba(255,255,255,.25)}
.btn-l{font-size:8px;color:rgba(255,255,255,.5);margin-top:2px}

/* Food drop animation */
#foodDrop{position:absolute;font-size:16px;opacity:0;pointer-events:none;z-index:12}
@keyframes dropFood{0%{opacity:1;transform:translateY(-40px)}100%{opacity:0;transform:translateY(0)}}

/* Sparkles for wash */
.sparkle{position:absolute;font-size:8px;animation:sparkleFloat 1s ease-out forwards;opacity:0;pointer-events:none}
@keyframes sparkleFloat{0%{opacity:1;transform:scale(.5) rotate(0deg)}50%{opacity:.8;transform:scale(1.2) rotate(180deg)}100%{opacity:0;transform:scale(.5) rotate(360deg) translateY(-20px)}}

/* Paw prints */
.pawprint{position:absolute;font-size:8px;opacity:0;pointer-events:none;animation:fadePaw 2s ease-out forwards}
@keyframes fadePaw{0%{opacity:.4}100%{opacity:0}}

/* Sound toggle */
#soundControls{display:flex;gap:4px;align-items:center}
</style>
</head>
<body class="day">
<div id="game">
  <div id="starsC"></div>
  <div id="cloudsC"></div>
  <div id="sun"></div>
  <div id="moon"></div>

  <div id="topBar">
    <div style="display:flex;gap:6px;align-items:center">
      <span id="nameTag">~ <em>Furbag Montefiore</em> ~</span>
    </div>
    <div id="soundControls">
      <button class="top-btn" id="btnMusic" title="Background music">üéµ</button>
      <button class="top-btn" id="btnMute" title="Sound effects">üîä</button>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <span id="clock">12 AM</span>
      <button class="top-btn" id="btnSpd">1x</button>
    </div>
  </div>

  <div id="room">
    <div id="window"><div id="windowGlow"></div></div>
    <div id="windowsill"></div>
    <div id="shelf"></div>
    <div id="shelfItems">
      <div class="book" style="height:14px;background:#c0392b"></div>
      <div class="book" style="height:16px;background:#2980b9"></div>
      <div class="book" style="height:12px;background:#27ae60"></div>
      <span id="plant">üå±</span>
    </div>
    <div id="floor">
      <div id="rug"></div>
    </div>
    <div id="bowl">üçó</div>
    <div id="bed"></div>
    <div id="yarn">üß∂</div>
    <div id="mouse">üê≠</div>
    <div id="foodDrop">üçó</div>

    <!-- Cat -->
    <div id="cw" class="facing-right">
      <div id="cat">
        <div id="zzz">z z z</div>
        <div id="hearts"></div>
        <div class="cat-head">
          <div class="ear-l"></div><div class="ear-r"></div>
          <div class="ear-inner-l"></div><div class="ear-inner-r"></div>
          <div class="eye-l"><div class="pupil"></div></div>
          <div class="eye-r"><div class="pupil"></div></div>
          <div class="nose"></div>
          <div class="mouth-l"></div><div class="mouth-r"></div>
          <div class="whisker wh-tl"></div><div class="whisker wh-ml"></div><div class="whisker wh-bl"></div>
          <div class="whisker wh-tr"></div><div class="whisker wh-mr"></div><div class="whisker wh-br"></div>
        </div>
        <div class="cat-body">
          <div class="leg leg-fl"></div><div class="leg leg-fr"></div>
          <div class="leg leg-bl"></div><div class="leg leg-br"></div>
        </div>
        <div class="tail"></div>
      </div>
    </div>

    <div id="al"></div>
  </div>

  <div id="stats">
    <div class="st"><div class="st-i">üçó</div><div class="st-b"><div class="st-f fd" id="sFd" style="width:70%"></div></div><div class="st-l">Fed</div></div>
    <div class="st"><div class="st-i">‚ö°</div><div class="st-b"><div class="st-f en" id="sEn" style="width:80%"></div></div><div class="st-l">Energy</div></div>
    <div class="st"><div class="st-i">üò∏</div><div class="st-b"><div class="st-f ha" id="sHa" style="width:70%"></div></div><div class="st-l">Happy</div></div>
    <div class="st"><div class="st-i">üíï</div><div class="st-b"><div class="st-f lo" id="sLo" style="width:60%"></div></div><div class="st-l">Love</div></div>
    <div class="st"><div class="st-i">‚ú®</div><div class="st-b"><div class="st-f cl" id="sCl" style="width:85%"></div></div><div class="st-l">Clean</div></div>
  </div>
  <div id="mood">Furbag is lounging...</div>
  <div class="btns">
    <div class="bg"><button class="btn" id="bFeed">üçó</button><div class="btn-l">Feed</div></div>
    <div class="bg"><button class="btn" id="bPet">ü§ö</button><div class="btn-l">Pet</div></div>
    <div class="bg"><button class="btn" id="bPlay">üß∂</button><div class="btn-l">Play</div></div>
    <div class="bg"><button class="btn" id="bSleep">üò¥</button><div class="btn-l">Sleep</div></div>
    <div class="bg"><button class="btn" id="bWash">üõÅ</button><div class="btn-l">Wash</div></div>
  </div>
</div>

<script>
// ===== SOUND ENGINE (Web Audio API synthesized sounds) =====
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let sfxMuted = false;
let musicPlaying = false;
let musicNodes = null;

function ensureAudio() {
  if (!audioCtx) audioCtx = new AudioCtx();
  if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playMeow() {
  if (sfxMuted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.setValueAtTime(600 + Math.random() * 200, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(400 + Math.random() * 100, audioCtx.currentTime + 0.15);
  o.frequency.exponentialRampToValueAtTime(500 + Math.random() * 150, audioCtx.currentTime + 0.3);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.4);
}

function playPurr() {
  if (sfxMuted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const lfo = audioCtx.createOscillator();
  const lfoG = audioCtx.createGain();
  o.type = 'sawtooth';
  o.frequency.value = 28;
  lfo.frequency.value = 26;
  lfoG.gain.value = 8;
  lfo.connect(lfoG).connect(o.frequency);
  g.gain.setValueAtTime(0.06, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
  o.connect(g).connect(audioCtx.destination);
  o.start(); lfo.start();
  o.stop(audioCtx.currentTime + 0.8); lfo.stop(audioCtx.currentTime + 0.8);
}

function playCrunch() {
  if (sfxMuted) return;
  ensureAudio();
  const bufSize = audioCtx.sampleRate * 0.08;
  const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufSize, 3);
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  const g = audioCtx.createGain();
  g.gain.value = 0.12;
  const f = audioCtx.createBiquadFilter();
  f.type = 'bandpass'; f.frequency.value = 2000 + Math.random() * 1000; f.Q.value = 2;
  src.connect(f).connect(g).connect(audioCtx.destination);
  src.start();
}

function playFootstep() {
  if (sfxMuted) return;
  ensureAudio();
  const bufSize = audioCtx.sampleRate * 0.04;
  const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufSize, 8);
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  const g = audioCtx.createGain();
  g.gain.value = 0.05;
  const f = audioCtx.createBiquadFilter();
  f.type = 'lowpass'; f.frequency.value = 800;
  src.connect(f).connect(g).connect(audioCtx.destination);
  src.start();
}

function playYarnBounce() {
  if (sfxMuted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.setValueAtTime(800, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.15);
  g.gain.setValueAtTime(0.1, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.15);
}

function playSplash() {
  if (sfxMuted) return;
  ensureAudio();
  const bufSize = audioCtx.sampleRate * 0.2;
  const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufSize, 2) * Math.sin(i * 0.1);
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  const g = audioCtx.createGain();
  g.gain.value = 0.08;
  const f = audioCtx.createBiquadFilter();
  f.type = 'highpass'; f.frequency.value = 3000;
  src.connect(f).connect(g).connect(audioCtx.destination);
  src.start();
}

function playChirp() {
  if (sfxMuted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.setValueAtTime(900, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.05);
  o.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.12);
  g.gain.setValueAtTime(0.08, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.12);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.12);
}

function playSnore() {
  if (sfxMuted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(60, audioCtx.currentTime);
  o.frequency.linearRampToValueAtTime(40, audioCtx.currentTime + 0.6);
  g.gain.setValueAtTime(0.03, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.3);
  g.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
  o.connect(g).connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.6);
}

// Background music - gentle ambient loop
function startMusic() {
  ensureAudio();
  if (musicNodes) return;
  const notes = [261.63, 329.63, 392.00, 349.23, 293.66, 261.63]; // C E G F D C
  let noteIdx = 0;
  const o1 = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const f = audioCtx.createBiquadFilter();
  o1.type = 'sine';
  o2.type = 'triangle';
  o2.detune.value = 5;
  f.type = 'lowpass'; f.frequency.value = 600;
  g.gain.value = 0.03;
  o1.connect(f); o2.connect(f);
  f.connect(g).connect(audioCtx.destination);
  o1.frequency.value = notes[0];
  o2.frequency.value = notes[0] * 0.5;
  o1.start(); o2.start();
  const interval = setInterval(() => {
    noteIdx = (noteIdx + 1) % notes.length;
    const t = audioCtx.currentTime;
    o1.frequency.linearRampToValueAtTime(notes[noteIdx], t + 1.5);
    o2.frequency.linearRampToValueAtTime(notes[noteIdx] * 0.5, t + 1.5);
  }, 3000);
  musicNodes = { o1, o2, g, interval };
}

function stopMusic() {
  if (!musicNodes) return;
  clearInterval(musicNodes.interval);
  musicNodes.o1.stop();
  musicNodes.o2.stop();
  musicNodes = null;
}

// ===== SKY SETUP =====
const stC = document.getElementById('starsC');
for (let i = 0; i < 50; i++) {
  const s = document.createElement('div');
  s.className = 'star';
  s.style.cssText = `left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*3}s;width:${Math.random()*2.5+.5}px;height:${Math.random()*2.5+.5}px`;
  stC.appendChild(s);
}
const clC = document.getElementById('cloudsC');
for (let i = 0; i < 4; i++) {
  const c = document.createElement('div');
  c.className = 'cloud';
  c.style.cssText = `top:${10+Math.random()*25}%;width:${60+Math.random()*80}px;height:${16+Math.random()*14}px;animation-duration:${30+Math.random()*40}s;animation-delay:${-Math.random()*60}s`;
  clC.appendChild(c);
}

// ===== GAME STATE =====
const S = 'Furbag', cw = document.getElementById('cw'), mood = document.getElementById('mood'), al = document.getElementById('al'), hearts = document.getElementById('hearts');
const room = document.getElementById('room');
const gameEl = document.getElementById('game');

const st = {
  hu: 70, en: 80, ha: 70, lo: 60, cl: 85,
  act: 'idle', gh: 0, spd: 1, at: null,
  catX: 50, catY: 14, // Y as % from bottom of room
  walking: false, facing: 1, // 1 = right, -1 = left
  location: 'floor', // floor, windowsill, shelf
  targetX: null, targetY: null,
  footstepTimer: null,
  blinkTimer: null,
  snoreTimer: null
};

// Locations where cat can be (x%, y% from bottom, name)
const LOCATIONS = {
  floor_left: { x: 15, y: 14, name: 'floor' },
  floor_center: { x: 50, y: 14, name: 'floor' },
  floor_right: { x: 85, y: 14, name: 'floor' },
  bowl: { x: 12, y: 14, name: 'floor' },
  yarn: { x: 38, y: 15, name: 'floor' },
  bed: { x: 60, y: 14, name: 'floor' },
  mouse: { x: 82, y: 14, name: 'floor' },
  windowsill: { x: 28, y: 52, name: 'windowsill' },
  shelf_area: { x: 78, y: 56, name: 'shelf' },
  rug_center: { x: 50, y: 20, name: 'floor' }
};

// ===== TIME OF DAY =====
function gtod(h) { if (h >= 6 && h < 8) return 'dawn'; if (h >= 8 && h < 18) return 'day'; if (h >= 18 && h < 20) return 'dusk'; return 'night'; }
function updTime() {
  document.body.className = gtod(st.gh);
  const a = st.gh >= 12 ? 'PM' : 'AM';
  let hr = st.gh % 12; if (hr === 0) hr = 12;
  document.getElementById('clock').textContent = hr + ' ' + a;
}

// ===== STAT BARS =====
function updBars() {
  document.getElementById('sFd').style.width = st.hu + '%';
  document.getElementById('sEn').style.width = st.en + '%';
  document.getElementById('sHa').style.width = st.ha + '%';
  document.getElementById('sLo').style.width = st.lo + '%';
  document.getElementById('sCl').style.width = st.cl + '%';
}

function clamp(v) { return Math.max(0, Math.min(100, v)); }

// ===== MOOD TEXT =====
function setMood(t) { mood.textContent = t; }

// ===== CAT POSITIONING =====
function setCatPos(x, y) {
  st.catX = x; st.catY = y;
  cw.style.left = x + '%';
  cw.style.bottom = (room.offsetHeight * (y / 100)) + 'px';
  cw.style.transform = 'translateX(-50%)';
}

function updateCatVisualPos() {
  cw.style.left = st.catX + '%';
  // Convert y% to actual pixels relative to room
  const roomH = room.offsetHeight;
  cw.style.bottom = (roomH * st.catY / 100) + 'px';
}

// ===== CAT ANIMATION STATES =====
function setCatState(state) {
  const cat = document.getElementById('cat');
  // Remove all state classes
  cw.className = cw.className.replace(/cat-\w+/g, '').trim();
  cw.classList.add('cat-' + state);
  // Keep facing class
  if (st.facing === 1) {
    cw.classList.remove('facing-left'); cw.classList.add('facing-right');
  } else {
    cw.classList.remove('facing-right'); cw.classList.add('facing-left');
  }
}

function setFacing(dir) {
  st.facing = dir;
  cw.classList.remove('facing-left', 'facing-right');
  cw.classList.add(dir === 1 ? 'facing-right' : 'facing-left');
}

// ===== MOVEMENT SYSTEM =====
let moveInterval = null;

function walkTo(targetX, targetY, callback) {
  if (moveInterval) clearInterval(moveInterval);
  if (st.footstepTimer) clearInterval(st.footstepTimer);

  st.targetX = targetX;
  st.targetY = targetY;
  st.walking = true;
  setCatState('walking');

  // Face direction
  if (targetX > st.catX) setFacing(1);
  else if (targetX < st.catX) setFacing(-1);

  // Footstep sounds
  st.footstepTimer = setInterval(() => playFootstep(), 250);

  // Paw prints
  let pawCounter = 0;

  moveInterval = setInterval(() => {
    const dx = targetX - st.catX;
    const dy = targetY - st.catY;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < 1.5) {
      clearInterval(moveInterval);
      clearInterval(st.footstepTimer);
      moveInterval = null;
      st.footstepTimer = null;
      st.walking = false;
      st.catX = targetX;
      st.catY = targetY;
      updateCatVisualPos();
      if (callback) callback();
      return;
    }

    const speed = 1.2;
    const mx = (dx / dist) * speed;
    const my = (dy / dist) * speed;
    st.catX += mx;
    st.catY += my;
    updateCatVisualPos();

    // Update facing while walking
    if (mx > 0.1) setFacing(1);
    else if (mx < -0.1) setFacing(-1);

    // Drop occasional paw prints
    pawCounter++;
    if (pawCounter % 8 === 0) {
      dropPawPrint(st.catX, st.catY);
    }
  }, 30);
}

function dropPawPrint(x, y) {
  const p = document.createElement('div');
  p.className = 'pawprint';
  p.textContent = 'üêæ';
  p.style.left = x + '%';
  p.style.bottom = (room.offsetHeight * y / 100 - 5) + 'px';
  room.appendChild(p);
  setTimeout(() => p.remove(), 2000);
}

function stopWalking() {
  if (moveInterval) { clearInterval(moveInterval); moveInterval = null; }
  if (st.footstepTimer) { clearInterval(st.footstepTimer); st.footstepTimer = null; }
  st.walking = false;
}

// ===== HEARTS & EFFECTS =====
function spawnHearts(count) {
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const h = document.createElement('div');
      h.className = 'heart';
      h.textContent = ['üíï', '‚ù§Ô∏è', 'üíó', 'üíñ'][Math.floor(Math.random() * 4)];
      h.style.setProperty('--hx', (Math.random() * 30 - 15) + 'px');
      h.style.left = (Math.random() * 20 - 10) + 'px';
      hearts.appendChild(h);
      setTimeout(() => h.remove(), 1000);
    }, i * 150);
  }
}

function spawnSparkles() {
  for (let i = 0; i < 6; i++) {
    setTimeout(() => {
      const s = document.createElement('div');
      s.className = 'sparkle';
      s.textContent = '‚ú®';
      s.style.left = (st.catX + Math.random() * 6 - 3) + '%';
      s.style.bottom = (room.offsetHeight * st.catY / 100 + Math.random() * 30) + 'px';
      room.appendChild(s);
      setTimeout(() => s.remove(), 1000);
    }, i * 200);
  }
}

function spawnMusicNotes() {
  for (let i = 0; i < 3; i++) {
    setTimeout(() => {
      const n = document.createElement('div');
      n.className = 'music-note';
      n.textContent = ['üéµ', 'üé∂', '‚ô™'][Math.floor(Math.random() * 3)];
      n.style.left = (st.catX + Math.random() * 8 - 4) + '%';
      n.style.bottom = (room.offsetHeight * st.catY / 100 + 30 + Math.random() * 20) + 'px';
      room.appendChild(n);
      setTimeout(() => n.remove(), 1500);
    }, i * 400);
  }
}

// ===== ACTIVITY FUNCTIONS =====
function busy() { return st.act !== 'idle'; }

function doActivity(name, duration, fn) {
  if (busy()) return;
  st.act = name;
  al.textContent = name.charAt(0).toUpperCase() + name.slice(1) + '...';
  al.style.opacity = '1';
  fn();
  setTimeout(() => {
    st.act = 'idle';
    al.style.opacity = '0';
    setCatState('idle');
    // Random blink after activity
    setTimeout(() => { setCatState('blinking'); setTimeout(() => setCatState('idle'), 3000); }, 500);
  }, duration / st.spd);
}

function doFeed() {
  doActivity('eating', 4000, () => {
    const bowlLoc = LOCATIONS.bowl;
    walkTo(bowlLoc.x, bowlLoc.y, () => {
      setCatState('eating');
      playMeow();
      // Crunch sounds
      let crunchCount = 0;
      const crunchInt = setInterval(() => {
        playCrunch();
        crunchCount++;
        if (crunchCount > 6) clearInterval(crunchInt);
      }, 400);
      // Food drop animation
      const fd = document.getElementById('foodDrop');
      fd.style.left = bowlLoc.x + '%';
      fd.style.bottom = (room.offsetHeight * bowlLoc.y / 100 + 30) + 'px';
      fd.style.opacity = '1';
      fd.style.animation = 'dropFood .5s ease-in forwards';
      setTimeout(() => { fd.style.opacity = '0'; fd.style.animation = 'none'; }, 600);
      setMood(S + ' munches happily!');
      st.hu = clamp(st.hu + 25);
      st.ha = clamp(st.ha + 5);
      updBars();
    });
  });
}

function doPet() {
  doActivity('purring', 3000, () => {
    setCatState('purring');
    playPurr();
    spawnHearts(5);
    setTimeout(() => playMeow(), 800);
    setMood(S + ' purrs loudly...');
    st.lo = clamp(st.lo + 20);
    st.ha = clamp(st.ha + 10);
    updBars();
  });
}

function doPlay() {
  doActivity('playing', 5000, () => {
    const targets = [LOCATIONS.yarn, LOCATIONS.mouse, LOCATIONS.rug_center];
    const target = targets[Math.floor(Math.random() * targets.length)];
    walkTo(target.x, target.y, () => {
      // Sequence: pounce, roll, play
      setCatState('pouncing');
      playChirp();
      setMood(S + ' pounces!');
      setTimeout(() => {
        playYarnBounce();
        setCatState('rolling');
        setMood(S + ' rolls around playfully!');
        spawnMusicNotes();
      }, 800);
      setTimeout(() => {
        setCatState('arched');
        playMeow();
        setMood(S + ' is having so much fun!');
      }, 2000);
      st.ha = clamp(st.ha + 20);
      st.en = clamp(st.en - 10);
      st.cl = clamp(st.cl - 5);
      updBars();
    });
  });
}

function doSleep() {
  doActivity('sleeping', 8000, () => {
    const bedLoc = LOCATIONS.bed;
    walkTo(bedLoc.x, bedLoc.y, () => {
      setCatState('sleeping');
      setMood(S + ' curls up to sleep...');
      // Snore sounds
      st.snoreTimer = setInterval(() => playSnore(), 2500);
      setTimeout(() => {
        if (st.snoreTimer) { clearInterval(st.snoreTimer); st.snoreTimer = null; }
      }, 7000);
      st.en = clamp(st.en + 30);
      st.ha = clamp(st.ha + 5);
      updBars();
    });
  });
}

function doWash() {
  doActivity('grooming', 4000, () => {
    setCatState('grooming');
    playSplash();
    spawnSparkles();
    setTimeout(() => plasSplashSafe(), 1000);
    setTimeout(() => spawnSparkles(), 1500);
    setMood(S + ' grooms himself clean!');
    st.cl = clamp(st.cl + 25);
    st.ha = clamp(st.ha + 5);
    updBars();
  });
}

function plasSplashSafe() { try { playSplash(); } catch(e) {} }

// ===== AUTONOMOUS BEHAVIOR =====
function autoAct() {
  if (busy()) return;
  const t = gtod(st.gh);
  const r = Math.random();

  // Night time - mostly sleep
  if (t === 'night' && st.en < 60) {
    doSleep(); return;
  }

  // Urgent needs
  if (st.hu < 20) { doFeed(); return; }
  if (st.en < 15) { doSleep(); return; }
  if (st.cl < 20) { doWash(); return; }

  // Random behaviors
  if (r < 0.2) {
    // Wander to random location
    const locs = Object.values(LOCATIONS);
    const dest = locs[Math.floor(Math.random() * locs.length)];
    walkTo(dest.x, dest.y, () => {
      setCatState('idle');
      // Random pose at destination
      const poses = ['blinking', 'curious', 'idle'];
      setCatState(poses[Math.floor(Math.random() * poses.length)]);
      if (dest.name === 'windowsill') setMood(S + ' gazes out the window...');
      else if (dest.name === 'shelf') setMood(S + ' surveys his kingdom from above...');
      else setMood(S + ' explores the room...');
      if (Math.random() < 0.3) playMeow();
    });
  } else if (r < 0.3) {
    // Jump to windowsill or shelf
    const elevated = [LOCATIONS.windowsill, LOCATIONS.shelf_area];
    const dest = elevated[Math.floor(Math.random() * elevated.length)];
    walkTo(dest.x, dest.y, () => {
      setCatState('idle');
      playChirp();
      if (dest.name === 'windowsill') setMood(S + ' sits on the windowsill, watching birds...');
      else setMood(S + ' lounges near the bookshelf...');
    });
  } else if (r < 0.4) {
    // Stretch
    setCatState('stretching');
    setMood(S + ' has a big stretch!');
    playMeow();
    setTimeout(() => setCatState('idle'), 2000);
  } else if (r < 0.5) {
    // Kneading / making biscuits
    setCatState('kneading');
    setMood(S + ' makes biscuits! üçû');
    playCrunch();
    playPurr();
    setTimeout(() => setCatState('idle'), 3000);
  } else if (r < 0.55) {
    // Curious head tilt
    setCatState('curious');
    setMood(S + ' tilts his head curiously...');
    playChirp();
    setTimeout(() => setCatState('idle'), 2000);
  } else if (r < 0.65 && st.hu < 50) {
    doFeed();
  } else if (r < 0.75 && st.ha < 50) {
    doPlay();
  } else if (r < 0.85 && st.cl < 50) {
    doWash();
  } else {
    // Idle variety
    const idleMoods = [
      S + ' is lounging...', S + ' blinks slowly at you.',
      S + ' flicks his tail.', S + ' licks his paw.',
      S + ' yawns.', S + "'s green eyes glow...",
      t === 'night' ? S + ' prowls in the moonlight...' : S + ' relaxes.',
      st.lo > 80 ? S + ' adores you!' : S + ' glances your way.',
      S + ' twitches an ear.', S + ' watches a dust mote float by...'
    ];
    setMood(idleMoods[Math.floor(Math.random() * idleMoods.length)]);
    // Random blink
    if (Math.random() < 0.4) setCatState('blinking');
  }
}

// ===== STAT DECAY =====
function decayStats() {
  st.hu = clamp(st.hu - 0.3);
  st.en = clamp(st.en - 0.15);
  st.ha = clamp(st.ha - 0.2);
  st.lo = clamp(st.lo - 0.1);
  st.cl = clamp(st.cl - 0.15);
  updBars();
}

// ===== BUTTON HANDLERS =====
document.getElementById('bFeed').onclick = doFeed;
document.getElementById('bPet').onclick = doPet;
document.getElementById('bPlay').onclick = doPlay;
document.getElementById('bSleep').onclick = doSleep;
document.getElementById('bWash').onclick = doWash;

// Tap cat to pet
cw.onclick = (e) => {
  e.stopPropagation();
  if (!busy()) doPet();
};

// Tap furniture
document.getElementById('bowl').onclick = () => { if (!busy()) doFeed(); };
document.getElementById('bed').onclick = () => { if (!busy()) doSleep(); };
document.getElementById('yarn').onclick = () => { if (!busy()) doPlay(); };
document.getElementById('mouse').onclick = () => { if (!busy()) doPlay(); };

// Speed button
const speeds = [1, 2, 5, 10, 30];
let spdIdx = 0;
document.getElementById('btnSpd').onclick = () => {
  spdIdx = (spdIdx + 1) % speeds.length;
  st.spd = speeds[spdIdx];
  document.getElementById('btnSpd').textContent = st.spd + 'x';
};

// Sound controls
document.getElementById('btnMute').onclick = () => {
  sfxMuted = !sfxMuted;
  document.getElementById('btnMute').textContent = sfxMuted ? 'üîá' : 'üîä';
};

document.getElementById('btnMusic').onclick = () => {
  if (musicPlaying) {
    stopMusic();
    musicPlaying = false;
    document.getElementById('btnMusic').textContent = 'üéµ';
  } else {
    startMusic();
    musicPlaying = true;
    document.getElementById('btnMusic').textContent = 'üé∂';
  }
};

// ===== GAME LOOP =====
st.gh = new Date().getHours();
updTime();
updBars();
setCatPos(50, 14);

// Time tick
setInterval(() => {
  st.gh = (st.gh + 1) % 24;
  updTime();
}, 60000 / st.spd > 0 ? 60000 / st.spd : 60000);

// More accurate time tick that respects speed
let lastTimeTick = Date.now();
setInterval(() => {
  const now = Date.now();
  const elapsed = now - lastTimeTick;
  if (elapsed >= 60000 / st.spd) {
    st.gh = (st.gh + 1) % 24;
    updTime();
    lastTimeTick = now;
  }
}, 1000);

// Stat decay
setInterval(() => decayStats(), 3000);

// Auto behavior
setInterval(() => autoAct(), 6000);

// Random mood text
setInterval(() => {
  if (!busy()) {
    const t = gtod(st.gh);
    const m = [
      S + ' is lounging...', S + ' blinks slowly at you.',
      st.hu < 30 ? S + ' eyes the food bowl...' : S + ' looks content.',
      st.en < 20 ? S + ' yawns widely...' : S + ' is relaxing.',
      st.lo > 80 ? S + ' adores you!' : S + ' glances your way.',
      t === 'night' ? S + "'s green eyes glow in the dark..." : null,
      t === 'dawn' ? S + ' watches the sunrise...' : null,
      t === 'dusk' ? S + ' silhouettes against the sunset...' : null,
      t === 'day' ? S + ' lounges in a sunbeam...' : null
    ].filter(Boolean);
    setMood(m[Math.floor(Math.random() * m.length)]);
  }
}, 8000);

// Resize handler for cat position
window.addEventListener('resize', updateCatVisualPos);
updateCatVisualPos();
</script>
</body>
</html>
